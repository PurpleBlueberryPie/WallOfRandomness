import React, { useState, useEffect, useRef } from 'react';

const categories = ['Branding', 'Packaging', 'Poster', 'Data', 'Social Media', 'Tees'];

const initialUrlArrays = {
  Branding: [
    'https://pbs.twimg.com/media/Example1.jpg',
    'https://images.unsplash.com/photo-Example2',
    'https://www.behance.net/gallery/Example3/image',
  ],
  Packaging: [
    'https://i.pinimg.com/originals/Example4.jpg',
    'https://assets.pinterest.com/Example5.jpg',
  ],
  Poster: [],
  Data: [],
  'Social Media': [],
  Tees: [],
};

const getImageUrl = (url) => {
  if (url.includes('twimg.com')) return url;
  if (url.includes('unsplash.com')) return `${url}&w=800&q=80`;
  if (url.includes('behance.net')) return url.replace('/image', '/project_modules/max_1200/');
  return url;
};

const ImageCard = ({ src }) => (
  <div style={{
    width: '100%',
    marginBottom: '1rem',
    overflow: 'hidden',
    borderRadius: '0.5rem',
    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
  }}>
    <img src={getImageUrl(src)} alt="Gallery item" style={{
      width: '100%',
      height: 'auto',
      objectFit: 'cover',
    }} />
  </div>
);

const EndlessScrollGallery = () => {
  const [selectedCategory, setSelectedCategory] = useState(categories[0]);
  const [images, setImages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [urlArrays, setUrlArrays] = useState(initialUrlArrays);
  const loader = useRef(null);

  const loadMoreImages = () => {
    setLoading(true);
    const categoryUrls = urlArrays[selectedCategory];
    if (categoryUrls.length === 0) {
      setLoading(false);
      return;
    }
    const newImages = [...Array(10)].map(() => {
      const randomIndex = Math.floor(Math.random() * categoryUrls.length);
      return categoryUrls[randomIndex];
    });
    setImages((prevImages) => [...prevImages, ...newImages]);
    setLoading(false);
  };

  useEffect(() => {
    setImages([]);
    loadMoreImages();
  }, [selectedCategory]);

  useEffect(() => {
    const options = {
      root: null,
      rootMargin: '20px',
      threshold: 1.0
    };

    const observer = new IntersectionObserver((entities) => {
      const target = entities[0];
      if (target.isIntersecting && !loading) {
        loadMoreImages();
      }
    }, options);

    if (loader.current) {
      observer.observe(loader.current);
    }

    return () => {
      if (loader.current) {
        observer.unobserve(loader.current);
      }
    };
  }, [loading, selectedCategory]);

  const addImageUrl = () => {
    const newUrl = prompt('Enter the URL of the image to add:');
    if (newUrl) {
      setUrlArrays((prevArrays) => ({
        ...prevArrays,
        [selectedCategory]: [...prevArrays[selectedCategory], newUrl]
      }));
      setImages((prevImages) => [...prevImages, newUrl]);
    }
  };

  return (
    <div style={{
      maxWidth: '64rem',
      margin: '0 auto',
      padding: '0 1rem',
    }}>
      <h1 style={{
        fontSize: '2.5rem',
        fontWeight: 'bold',
        textAlign: 'center',
        margin: '2rem 0',
      }}>Wall of Randomness</h1>
      <div style={{
        display: 'flex',
        justifyContent: 'center',
        overflowX: 'auto',
        marginBottom: '2rem',
      }}>
        {categories.map((category) => (
          <button
            key={category}
            onClick={() => setSelectedCategory(category)}
            style={{
              padding: '0.5rem 1rem',
              borderRadius: '9999px',
              marginRight: '1rem',
              backgroundColor: selectedCategory === category ? '#3B82F6' : '#E5E7EB',
              color: selectedCategory === category ? 'white' : '#374151',
              border: 'none',
              cursor: 'pointer',
            }}
          >
            {category}
          </button>
        ))}
      </div>
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
        gap: '1rem',
      }}>
        {images.map((src, index) => (
          <ImageCard key={`${src}-${index}`} src={src} />
        ))}
      </div>
      <div ref={loader} style={{ height: '2.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        {loading && <p>Loading...</p>}
      </div>
      <button
        onClick={addImageUrl}
        style={{
          position: 'fixed',
          bottom: '2rem',
          right: '2rem',
          backgroundColor: '#3B82F6',
          color: 'white',
          padding: '0.75rem',
          borderRadius: '9999px',
          border: 'none',
          cursor: 'pointer',
          boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
        }}
      >
        +
      </button>
    </div>
  );
};

export default EndlessScrollGallery;
